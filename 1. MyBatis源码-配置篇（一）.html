<html>
<head>
  <title>Evernote Export</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/601568 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="691"/>

<div>
<span><div>1. 先看个简单的配置：   </div><div>mybatis-config.xml</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</div><div>&lt;!DOCTYPE configuration  PUBLIC &quot;-//mybatis.org//DTD Config 3.0//EN&quot;</div><div>        &quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt;</div><div>&lt;configuration&gt;</div><div>    &lt;properties resource=&quot;jdbc.properties&quot;/&gt;</div><div>    &lt;!--&lt;typeAliases&gt;--&gt;</div><div>        &lt;!--&lt;typeAlias alias=&quot;employee&quot; type=&quot;Employee&quot;/&gt;--&gt;</div><div>    &lt;!--&lt;/typeAliases&gt; --&gt;</div><div>    &lt;environments default=&quot;development&quot;&gt;</div><div>        &lt;environment id=&quot;development&quot;&gt;</div><div>            &lt;transactionManager type=&quot;JDBC&quot;/&gt;</div><div>            &lt;!--配置连接池--&gt;</div><div>            &lt;dataSource type=&quot;POOLED&quot;&gt;</div><div>                &lt;property name=&quot;driver&quot; value=&quot;${database.driver}&quot;/&gt;</div><div>                &lt;property name=&quot;url&quot; value=&quot;${database.url}&quot;/&gt;</div><div>                &lt;property name=&quot;username&quot; value=&quot;${database.username}&quot;/&gt;</div><div>                &lt;property name=&quot;password&quot; value=&quot;${database.password}&quot;/&gt;</div><div>            &lt;/dataSource&gt;</div><div>        &lt;/environment&gt;</div><div>    &lt;/environments&gt;</div><div>    &lt;!--引入我们自己写的每一个接口的实现文件名称--&gt;</div><div>    &lt;mappers&gt;</div><div>        &lt;!--resource标识从类路径下找资源--&gt;</div><div>        &lt;!--&lt;package name=&quot;mapper&quot;/&gt;--&gt;</div><div>        &lt;mapper resource=&quot;mapper/UserCardMapper.xml&quot;/&gt;</div><div>        &lt;mapper resource=&quot;mapper/UserMapper.xml&quot;/&gt;</div><div>        &lt;mapper resource=&quot;mapper/UserAuthMapper.xml&quot;/&gt;</div><div>        &lt;mapper resource=&quot;mapper/PayOrderMapper.xml&quot;/&gt;</div><div>    &lt;/mappers&gt;</div><div>&lt;/configuration&gt;</div></div><div><br/></div><div>jdbc.properties</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>database.driver=com.mysql.jdbc.Driver</div><div>database.url=jdbc:mysql://localhost:3306/yolyn_authpay?serverTimezone=UTC&amp;characterEncoding=UTF-8</div><div>database.username=root</div><div>database.password=root</div></div><div><br/></div><div>我们来看看配置是怎么解析的    </div><div><br/></div><div>在读取配置的时候我们会写下下面几行代码：   </div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>public class SqlSessionUtil {</div><div>    private static SqlSessionFactory sqlSessionFactory;</div><div>    static {</div><div>        try {</div><div>            <span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;"><b>InputStream is = Resources.getResourceAsStream(&quot;mybatis-config.xml&quot;);</b></span></div><div>            <span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;"><b> sqlSessionFactory=new SqlSessionFactoryBuilder()<font color="#FF0000">.build(is)</font>;</b></span></div><div>        } catch (IOException e) {</div><div>            e.printStackTrace();</div><div>        }</div><div>    }</div><div>    public static SqlSession getSqlSession(){</div><div>        return sqlSessionFactory.openSession();</div><div>    }</div><div>}</div></div><div>重点看上面黄色的，传入了配置文件名，我们看配置是怎么解析的：</div><div><br/></div><div>build方法点进去      </div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>public SqlSessionFactory build(InputStream inputStream) {</div><div> <span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;"><b> return build(inputStream, null, null);</b></span></div><div>}</div></div><div>再进build方法</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>public SqlSessionFactory build(InputStream inputStream, String environment, Properties properties) {</div><div>  try {</div><div><b style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">    XMLConfigBuilder parser = new XMLConfigBuilder(inputStream, environment, properties);</b></div><div><b style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">    return <font color="#6BE748">build</font>(parser.<font color="#FF0000">parse()</font>);</b></div><div>  } catch (Exception e) {</div><div>    throw ExceptionFactory.wrapException(&quot;Error building SqlSession.&quot;, e);</div><div>  } finally {</div><div>    ErrorContext.instance().reset();</div><div>    try {</div><div>      inputStream.close();</div><div>    } catch (IOException e) {</div><div>      // Intentionally ignore. Prefer previous error.</div><div>    }</div><div>  }</div></div><div><span style="box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">这里可以看到创建了一个XMLConfigBuilder来解析这个文件流，然后传到build方法，先看下这个build方法再进parse方法看看:</span></div><div><span style="box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">build方法</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>public SqlSessionFactory build(Configuration config) {</div><div>  return new DefaultSqlSessionFactory(config);</div><div>}</div></div><div><br/></div><div>注意看下这个build方法传入的是啥，一个Configuration实例，那说明XMLConfigBuilder.parse()方法返回的是一个Configuration，看下parse方法</div><div><br/></div><div>parse方法</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>public Configuration parse() {</div><div>  if (parsed) {</div><div>    throw new BuilderException(&quot;Each XMLConfigBuilder can only be used once.&quot;);</div><div>  }</div><div>  parsed = true;</div><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;"><b>  parseConfiguration(parser.evalNode(&quot;/configuration&quot;));</b></span></div><div>  return configuration;</div><div>}</div></div><div>看返回的是啥，啊哈，一个Configuration，并且这里用了一个parsed变量保证配置文件只解析一次，parsed初始值为false，看下这个parseConfiguration方法   </div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><br/></div><div><br/></div><div>private void parseConfiguration(XNode root) {</div><div>  try {</div><div>    //issue #117 read properties first</div><div>    propertiesElement(root.evalNode(&quot;properties&quot;));//获取额外的properties配置</div><div>    Properties settings = settingsAsProperties(root.evalNode(&quot;settings&quot;));</div><div>    loadCustomVfs(settings);</div><div>    typeAliasesElement(root.evalNode(&quot;typeAliases&quot;));</div><div>    pluginElement(root.evalNode(&quot;plugins&quot;));</div><div>    objectFactoryElement(root.evalNode(&quot;objectFactory&quot;));</div><div>    objectWrapperFactoryElement(root.evalNode(&quot;objectWrapperFactory&quot;));</div><div>    reflectorFactoryElement(root.evalNode(&quot;reflectorFactory&quot;));</div><div>    settingsElement(settings);</div><div>    // read it after objectFactory and objectWrapperFactory issue #631</div><div>    environmentsElement(root.evalNode(&quot;environments&quot;));</div><div>    databaseIdProviderElement(root.evalNode(&quot;databaseIdProvider&quot;));</div><div>    typeHandlerElement(root.evalNode(&quot;typeHandlers&quot;));</div><div>    mapperElement(root.evalNode(&quot;mappers&quot;));</div><div>  } catch (Exception e) {</div><div>    throw new BuilderException(&quot;Error parsing SQL Mapper Configuration. Cause: &quot; + e, e);</div><div>  }</div><div>}</div></div><div>激不激动，刺不刺激，这里可干了好多事情哦，我们挑几个看下：   </div><div>- 1. propertiesElement(root.evalNode(&quot;properties&quot;));</div><div>获取并解析额外的配置文件，我们在这个例子一开始写了一个jdbc连接配置，我们看下这个方法：  </div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>private void propertiesElement(XNode context) throws Exception {</div><div>  if (context != null) {</div><div>    <span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;"><b>Properties</b></span> defaults = context.getChildrenAsProperties();</div><div>    String resource = context.getStringAttribute(&quot;resource&quot;);</div><div>    String url = context.getStringAttribute(&quot;url&quot;);</div><div>    if (resource != null &amp;&amp; url != null) {</div><div>      throw new BuilderException(&quot;The properties element cannot specify both a URL and a resource based property file reference.  Please specify one or the other.&quot;);//不能同时存在两个配置源</div><div>    }</div><div>    if (resource != null) {</div><div>    <span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;"><b>  defaults.putAll(Resources.<font color="#FF0000">getResourceAsProperties(resource)</font>);</b></span></div><div>    } else if (url != null) {</div><div>      defaults.putAll(Resources.getUrlAsProperties(url));</div><div>    }</div><div>    Properties vars = configuration.getVariables();</div><div>    if (vars != null) {</div><div>      defaults.putAll(vars);</div><div>    }</div><div>    parser.setVariables(defaults);</div><div>    configuration.setVariables(defaults);</div><div>  }</div><div>}</div></div><div>我们要知道这个Properties是一个HashTable，解析后的配置以键值对的形式保存在这个HashTable里面，不信的话可以看下getResourceAsProperties方法</div><div>getResourceAsProperties方法</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>public static Properties getResourceAsProperties(String resource) throws IOException {</div><div>  Properties props = new Properties();</div><div>  InputStream in = getResourceAsStream(resource);</div><div>  props.load(in);</div><div>  in.close();</div><div>  return props;</div><div>}</div></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>public synchronized void load(InputStream inStream) throws IOException {</div><div>    load0(new LineReader(inStream));</div><div>}</div><div><br/></div><div>private void load0 (LineReader lr) throws IOException {</div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;"><span>    </span><span>    </span><span>    </span><span>    //此处省略好多代码</span><br/></span></div><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">        String key = loadConvert(lr.lineBuf, 0, keyLen, convtBuf);</span></div><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">        String value = loadConvert(lr.lineBuf, valueStart, limit - valueStart, convtBuf);</span></div><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">        put(key, value);</span></div><div>    }</div><div>}</div></div><div>看到了吧，还有啥好说的，就是这样，到这里一定好奇一开始配置连接池的时候，额外配置文件jdbc.properties的值是怎么塞进去的吧，我们再看下</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>&lt;environments default=&quot;development&quot;&gt;</div><div>        &lt;environment id=&quot;development&quot;&gt;</div><div>            &lt;transactionManager type=&quot;JDBC&quot;/&gt;</div><div>            &lt;!--配置连接池--&gt;</div><div>            &lt;dataSource type=&quot;POOLED&quot;&gt;</div><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">                &lt;property name=&quot;driver&quot; value=&quot;${database.driver}&quot;/&gt;</span></div><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">                &lt;property name=&quot;url&quot; value=&quot;${database.url}&quot;/&gt;</span></div><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">                &lt;property name=&quot;username&quot; value=&quot;${database.username}&quot;/&gt;</span></div><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">                &lt;property name=&quot;password&quot; value=&quot;${database.password}&quot;/&gt;</span></div><div>            &lt;/dataSource&gt;</div><div>        &lt;/environment&gt;</div><div>    &lt;/environments&gt;</div></div><div><font color="#4DCE1D"><br/></font></div><div><font color="#4DCE1D">哎呀，自己看去吧，懒得扒了。。。</font></div><div>反正这些配置相关的东西大多最终都是放在Configuration里面，包括Mapper，不信你自己看去，除此之外还有些东西是放在map里面，如TypeHandler啦，不信你可以去看XMLConfigBuilder的父类BaseBuilder中的<span style="color: rgb(0, 0, 0); font-family: Consolas; font-size: 9pt;">TypeHandlerRegistry</span></div><div><span style="color: rgb(0, 0, 0); font-family: Consolas; font-size: 9pt;"><br/></span></div><div><span style="color: rgb(0, 0, 0); font-family: Consolas; font-size: 9pt;">这篇点到为止，有的东西需要自己去翻一翻，下篇讲下自己不想扒的东西</span></div><div><span style="color: rgb(0, 0, 0); font-family: Consolas; font-size: 9pt;"><br/></span></div></span>
</div></body></html> 